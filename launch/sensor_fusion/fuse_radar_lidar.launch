<launch>

    <param name="use_sim_time" value="true"/>

    <arg name="launch_static_tf"       default="true"/>
    <arg name="launch_rqt_reconfigure" default="true"/>
    <arg name="launch_mcl2d"           default="true"/>
    <arg name="play_bag"               default="true"/>
    <arg name="sec"                    default="50"/>
    <arg name="rate"                   default="1"/>

    <arg name="bag_name"               default="2020-12-01-10-45-22_front_cam_odomtf"/>
    <arg name="bag_file"               default="$(env HOME)/radar_fusion_bags/$(arg bag_name).bag"/>
    
    <node name="bag_player" type="play" pkg="rosbag" 
          args="$(arg bag_file) --pause -r $(arg rate) --clock -s $(arg sec) -q -l" 
          output="screen" if="$(arg play_bag)"/>

    <!--  MCL2D initial position -->
    <arg name="initial_pose_x"  default="6.1"/>
    <arg name="initial_pose_y"  default="4.2"/>
    <arg name="initial_pose_a"  default="1.1"/>

    <arg name="use_async_concatenator"      default="false"/>
    <arg name="radar_full_cloud_topic_name" default="radarConcatenatedCloud"/>
    
    <arg name="cloud_1" default="/ti_mmwave_front_radar/radar_scan_pcl"/>
    <arg name="cloud_2" default="/ti_mmwave_left_radar/radar_scan_pcl"/>
    <arg name="cloud_3" default="/ti_mmwave_right_radar/radar_scan_pcl"/>
    <arg name="cloud_4" default="/ti_mmwave_rear_radar/radar_scan_pcl"/>

    <node name="async_cloud_concatenator" pkg="cloud_concatenator" type="async_concatenator_node" if="$(arg use_async_concatenator)">
        <remap from="cloud1"       to="$(arg cloud_1)"/>
        <remap from="cloud2"       to="$(arg cloud_2)"/>
        <remap from="cloud3"       to="$(arg cloud_3)"/>
        <remap from="cloud4"       to="$(arg cloud_4)"/>
        <remap from="full_cloud" to="$(arg radar_full_cloud_topic_name)"/>
        <param name="frequency"    value="10"/>
        <param name="target_frame" value="ti_mmwave_front_radar"/>
    </node>

    <arg name="n_clouds" default="4"/>

    <node name="cloud_concatenator" pkg="cloud_concatenator" type="cloud_concatenator_node" output="screen" unless="$(arg use_async_concatenator)">
        <param name="n_clouds" value="$(arg n_clouds)"/>
        <remap from="pc_1" to="$(arg cloud_1)"/>
        <remap from="pc_2" to="$(arg cloud_2)"/>
        <remap from="pc_3" to="$(arg cloud_3)"/>
        <remap from="pc_4" to="$(arg cloud_4)"/>
        <remap from="concatenatedCloud" to="$(arg radar_full_cloud_topic_name)"/>
    </node>

    <!-- Sync policy param -->
    <arg name="sychronization_margin"             default="10"/>
    <arg name="time_tolerance"                    default="0.3"/>

    <!-- Virtual 2D Scan extraction Config -->
    <arg name="yaw_tolerance"                     default="0.04"/>

    <!-- RANSAC Config -->
        <!-- Lidar -->
    <arg name="lidar_ransac_distance_threshold"   default="0.03"/>
    <arg name="lidar_ransac_iterations"           default="6"/>
    <arg name="lidar_min_ransac_pointcloud_size"  default="50"/>
        <!-- Radar -->
    <arg name="radar_ransac_distance_threshold"   default="0.05"/>
    <arg name="radar_ransac_iterations"           default="0"/> <!-- Set to 0 to disable-->
    <arg name="radar_min_ransac_pointcloud_size"  default="15"/>

    <!-- Third step -->
    <arg name="beta"                              default="0.2"/> <!-- According to paper, beta varies between 0 and 1 -->
    <arg name="distance_threshold"                default="0.5"/> <!-- Parameter dF of the paper -->

    <!-- Radar and Lidar standard deviations -->
    <arg name="radar_dev"                         default="0.03"/> 
    <arg name="lidar_dev"                         default="0.02"/> 
    <arg name="lidar_max_range"                   default="120.0"/> <!-- Useful when lidar pointclouds publishes ranges with Inf values. Ouster lidar I think does not do-->

    <arg name="enable_radar_enhancement"          default="false"/>
    <arg name="fuse_only_enhaced_radar"           default="false"/> 
    <arg name="max_radar_acc_yaw_incr"            default="0.4"/> 
    <arg name="max_radar_acc_time"                default="2.5"/> 

    <node name="lidar_radar_fusion_node" type="lidar_radar_fusion_node" pkg="radar_experiments" output="screen">
        <remap from="lidar_points"                       to="/os1_cloud_node/points_non_dense"/>
        <remap from="radar_points"                       to="/$(arg radar_full_cloud_topic_name)"/>
        <param name="yaw_tolerance"                      value="$(arg yaw_tolerance)"/>
        <param name="lidar_ransac_distance_threshold"    value="$(arg lidar_ransac_distance_threshold)"/>
        <param name="lidar_ransac_iterations"            value="$(arg lidar_ransac_iterations)"/>
        <param name="lidar_min_ransac_pointcloud_size"   value="$(arg lidar_min_ransac_pointcloud_size)"/>
        <param name="radar_ransac_distance_threshold"    value="$(arg radar_ransac_distance_threshold)"/>
        <param name="radar_ransac_iterations"            value="$(arg radar_ransac_iterations)"/>
        <param name="radar_min_ransac_pointcloud_size"   value="$(arg radar_min_ransac_pointcloud_size)"/>
        <param name="beta"                               value="$(arg beta)"/>
        <param name="distance_threshold"                 value="$(arg distance_threshold)"/>
        <param name="sychronization_margin"              value="$(arg sychronization_margin)"/>
        <param name="time_tolerance"                     value="$(arg time_tolerance)"/>
        <param name="radar_dev"                          value="$(arg radar_dev)"/>
        <param name="enable_radar_enhancement"           value="$(arg enable_radar_enhancement)"/>
        <param name="fuse_only_enhaced_radar"            value="$(arg fuse_only_enhaced_radar)"/>
        <param name="max_radar_acc_yaw_incr"             value="$(arg max_radar_acc_yaw_incr)"/>
        <param name="max_radar_acc_time"                 value="$(arg max_radar_acc_time)"/>
    </node>
    
    <arg name="pi"   value="3.141592654"/>
    
    <node pkg="pointcloud_to_laserscan" type="pointcloud_to_laserscan_node" name="pointcloud_to_laserscan">
        <remap from="cloud_in"            to="/lidar_radar_fusion_node/final_result_cloud"/>
        <remap from="scan"                to="/lidar_radar_fusion_node/result_laser_scan"/>
        <param name="min_height"          value="-1.0"/>
        <param name="max_height"          value="1.0"/>
        <param name="angle_min"           value="$(eval -1*arg('pi'))"/>
        <param name="angle_max"           value="$(eval arg('pi'))"/>
        <!-- <param name="angle_increment"     value="$(arg"/> -->
        <param name="queue_size"          value="1"/>
        <param name="scan_time"           value="0.1"/>
        <param name="range_min"           value="0.5"/>
        <param name="range_max"           value="120"/>
        <param name="target_frame"        value="os1_lidar"/>
        <param name="transform_tolerance" value="0.5"/>
    </node>

    <!-- MCL 2D Stuff -->
    <arg name="map2d_name" default="tunel2d_map4"/>

    <node pkg="map_server" name="map_server" type="map_server" args="$(find radar_experiments)/maps/$(arg map2d_name).yaml"/>

    <node pkg="odom_to_tf" type="odom_to_tf.py" name="odom_to_tf" if="$(arg launch_mcl2d)"> 
	  <param name="laser_frame" value="base_link"/>
	  <param name="rotate_90" value="false"/>
    </node> 

    <node pkg="amcl" type="amcl" name="amcl" output="screen" if="$(arg launch_mcl2d)">
      <!-- Publish scans from best pose at a max of 10 Hz -->
      <remap from="scan"                      to="/lidar_radar_fusion_node/result_laser_scan"/>
      <param name="initial_pose_x"            value="$(arg initial_pose_x)"/>
      <param name="initial_pose_y"            value="$(arg initial_pose_y)"/>
      <param name="initial_pose_a"            value="$(arg initial_pose_a)"/>
      <param name="odom_model_type"           value="diff"/>
      <param name="transform_tolerance"       value="0.2" />
      <param name="gui_publish_rate"          value="10.0"/>
      <param name="laser_max_beams"           value="60"/>
      <param name="min_particles"             value="500"/>
      <param name="max_particles"             value="5000"/>
      <param name="kld_err"                   value="0.05"/>
      <param name="kld_z"                     value="0.99"/>
      <param name="odom_alpha1"               value="0.5"/>
      <param name="odom_alpha2"               value="0.2"/>
      <!-- translation std dev, m -->
      <param name="odom_alpha3"               value="0.05"/>
      <param name="odom_alpha4"               value="0.05"/>
      <param name="odom_alpha5"               value="0.1"/>
      <param name="laser_z_hit"               value="0.5"/>
      <param name="laser_z_short"             value="0.05"/>
      <param name="laser_z_max"               value="0.05"/>
      <param name="laser_z_rand"              value="0.8"/>
      <param name="laser_sigma_hit"           value="0.2"/>
      <param name="laser_lambda_short"        value="0.1"/>
      <param name="laser_lambda_short"        value="0.1"/>
      <param name="laser_model_type"          value="likelihood_field"/>
      <!-- <param name="laser_model_type" value="beam"/> -->
      <param name="laser_likelihood_max_dist" value="2.0"/>
      <param name="update_min_d"              value="0.2"/>
      <param name="update_min_a"              value="0.5"/>
      <param name="odom_frame_id"             value="odom"/>
      <param name="resample_interval"         value="1"/>
      <param name="transform_tolerance"       value="0.1"/>
      <param name="recovery_alpha_slow"       value="0.0"/>
      <param name="recovery_alpha_fast"       value="0.0"/>
    </node>

    <node pkg="raposa_marker" type="raposa_marker" name="raposa_marker"/>

    <node name="rviz" pkg="rviz" type="rviz" args="-d $(find radar_experiments)/rviz/fuse_sensors.rviz"/>
    <node pkg="rqt_reconfigure" name="rqt_reconfigure" type="rqt_reconfigure" if="$(arg launch_rqt_reconfigure)"/>
    <!-- Static TFs -->

    <arg name="pi/2" value="1.5707963267948966"/>

    <node if="$(arg launch_static_tf)" pkg="tf" type="static_transform_publisher" name="os1_sensor_broadcaster" args="0.1 0 0.40 0 0 0               base_link  os1_sensor            2"/>
    <node if="$(arg launch_static_tf)" pkg="tf" type="static_transform_publisher" name="tf_lidar"               args="0 0.0 0.03618 3.14 0.0 0.0     os1_sensor os1_lidar             2"/>
    <node if="$(arg launch_static_tf)" pkg="tf" type="static_transform_publisher" name="tf_radar_front"         args="0.09 0.04 -0.08 0 0 0          os1_sensor ti_mmwave_front_radar 2"/>
    <node if="$(arg launch_static_tf)" pkg="tf" type="static_transform_publisher" name="tf_radar_rear"          args="-0.33 0.05 -0.2 $(arg pi) 0 0  os1_sensor ti_mmwave_rear_radar  2"/>
    <node if="$(arg launch_static_tf)" pkg="tf" type="static_transform_publisher" name="tf_radar_right"         args="0 -0.05 -0.05 -$(arg pi/2) 0 0 os1_sensor ti_mmwave_right_radar 2"/>
    <node if="$(arg launch_static_tf)" pkg="tf" type="static_transform_publisher" name="tf_radar_left"          args="0 0.05 -0.05 $(arg pi/2) 0 0   os1_sensor ti_mmwave_left_radar  2"/>

</launch>