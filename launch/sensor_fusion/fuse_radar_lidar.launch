<launch>

    <param name="use_sim_time" value="true"/>
    
    <arg name="play_bag" default="true"/>
    <arg name="sec"      default="1"/>
    <arg name="rate"     default="1"/>

    <arg name="bag_name" default="2020-12-01-13-21-03"/>
    <arg name="bag_file" default="$(env HOME)/$(arg bag_name).bag"/>
    
    <node name="bag_player" type="play" pkg="rosbag" 
          args="$(arg bag_file) -r $(arg rate) --clock -s $(arg sec) -q -l" 
          output="screen" if="$(arg play_bag)"/>

    <arg name="radar_full_cloud_topic_name" default="radarConcatenatedCloud"/>
    <arg name="n_clouds" default="4"/>
    <arg name="cloud_1" default="/ti_mmwave_front_radar/radar_scan_pcl"/>
    <arg name="cloud_2" default="/ti_mmwave_left_radar/radar_scan_pcl"/>
    <arg name="cloud_3" default="/ti_mmwave_right_radar/radar_scan_pcl"/>
    <arg name="cloud_4" default="/ti_mmwave_rear_radar/radar_scan_pcl"/>

    <node name="cloud_concatenator" pkg="cloud_concatenator" type="cloud_concatenator_node" output="screen">
        <param name="n_clouds" value="$(arg n_clouds)"/>
        <remap from="pc_1" to="$(arg cloud_1)"/>
        <remap from="pc_2" to="$(arg cloud_2)"/>
        <remap from="pc_3" to="$(arg cloud_3)"/>
        <remap from="pc_4" to="$(arg cloud_4)"/>
        <remap from="concatenatedCloud" to="$(arg radar_full_cloud_topic_name)"/>
    </node>

    <!-- Sync policy param -->
    <arg name="sychronization_margin"       default="10"/>
    <arg name="time_tolerance"              default="0.3"/>

    <!-- Virtual 2D Scan extraction Config -->
    <arg name="yaw_tolerance"               default="0.04"/>

    <!-- RANSAC Config -->
    <arg name="ransac_distance_threshold"   default="0.05"/>
    <arg name="ransac_iterations"           default="6"/>
    <arg name="min_ransac_pointcloud_size"  default="15"/>

    <!-- Third step -->
    <arg name="beta"                        default="0.2"/> <!-- According to paper, beta varies between 0 and 1 -->
    <arg name="distance_threshold"          default="0.25"/> <!-- Parameter dF of the paper -->

    <!-- Radar and Lidar standard deviations -->
    <arg name="radar_dev"                   default="0.03"/> 
    <arg name="lidar_dev"                   default="0.02"/> 

    <node name="lidar_radar_fusion_node" type="lidar_radar_fusion_node" pkg="radar_experiments" output="screen">
        <remap from="lidar_points"                 to="/os1_cloud_node/points_non_dense"/>
        <remap from="radar_points"                 to="/$(arg radar_full_cloud_topic_name)"/>
        <param name="yaw_tolerance"                value="$(arg yaw_tolerance)"/>
        <param name="ransac_distance_threshold"    value="$(arg ransac_distance_threshold)"/>
        <param name="ransac_iterations"            value="$(arg ransac_iterations)"/>
        <param name="min_ransac_pointcloud_size"   value="$(arg min_ransac_pointcloud_size)"/>
        <param name="beta"                         value="$(arg beta)"/>
        <param name="distance_threshold"           value="$(arg distance_threshold)"/>
        <param name="sychronization_margin"        value="$(arg sychronization_margin)"/>
        <param name="time_tolerance"               value="$(arg time_tolerance)"/>
        <param name="radar_dev"                    value="$(arg radar_dev)"/>
        <param name="lidar_dev"                    value="$(arg lidar_dev)"/>
    </node>

    <node name="rviz" pkg="rviz" type="rviz" args="-d $(find radar_experiments)/rviz/fuse_sensors.rviz"/>

</launch>